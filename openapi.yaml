openapi: 3.0.0
info:
  title: Mlog API
  description: API Gateway for post Microservices (Content, Engagement)
  version: 1.0.0

servers:
  - url: http://localhost:5000

paths:
  # some basic user routes
  /api/v1/users:
    get:
      summary: Get all users
      operationId: listAllUsers
      tags: [users]
      responses: 
        "200":
          description: get all users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/userResponse"
                  
  /api/v1/users/{user_id}:
    get:
      summary: Get a specific user with the user_id
      operationId: getUser 
      tags: [users]
      parameters:
        - name: user_id
          in: path
          required: true
          schema: { type: string }
      responses: 
        "200":
          description: Get a specific user with the user_id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/userResponse"
                
  /api/v1/users/me:
    get:
      summary: Get my user info
      operationId: getCurrentUser
      tags: [users]
      responses: 
        "200":
          description: Get my user info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/userResponse"


  # some basic admin routes
  /api/v1/admin/users/{user_id}/ban:
    post:
      summary: Ban user with user_id
      operationId: banUser
      tags: [admin]
      parameters:
        - in: path
          name: user_id
          required: true
          schema: 
            type: string
      requestBody:
        description: Information about why the user is banned
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: The reason for banning the user
              required:
                - reason
      responses:
        "200":
          description: User banned successfully

  /api/v1/admin/users/{user_id}/unban:
    post:
      summary: Unban user with user_id
      operationId: unbanUser
      tags: [admin]
      parameters:
        - in: path
          name: user_id
          required: true
          schema: 
            type: string
      requestBody:
        description: Informations about why the user is unbanned
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: The reason for unbanning the user
              required:
                - reason
      responses:
        "200":
          description: User unbanned successfully



  # keycloak stuffs
  /api/v1/auth:
    get: 
      summary: Redirect to Keycloak account management page 
      tags: [keycloak]
      responses: 
        '302': 
          description: Redirect to Keycloak
  # /api/v1/auth/me:
  #   get:
  #     summary: Returns user info that keycloak holds
  /api/v1/auth/login:
    get:
      summary: Redirect user to Keycloak for login
      tags: [keycloak]
      responses:
        '302':
          description: Redirect to Keycloak login page
  /api/v1/auth/callback:
    get:
      summary: OAuth2 callback endpoint for Keycloak
      tags: [keycloak]
      parameters:
        - in: query
          name: code
          schema: { type: string }
      responses:
        '200':
          description: Login successful, Session Cookie set
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  sessionId: { type: string }
  /api/v1/auth/logout:
    get:
      summary: Logout user and end Keycloak session
      tags: [keycloak]
      responses:
        '302':
          description: Redirect to Keycloak logout page
  /api/v1/auth/register:
    get:
      summary: Redirect to Keycloak registration page
      tags: [keycloak]
      responses:
        '302':
          description: Redirect to Keycloak
  /api/v1/auth/password/reset:
    get:
      summary: Redirect to Keycloak password reset page
      tags: [keycloak]
      responses:
        '302':
          description: Redirect to Keycloak





  # ==========================================
  # post SERVICE (Content Management)
  # ==========================================
  /api/v1/posts:
    get:
      summary: Returns list of all posts
      tags: [posts]
      responses:
        "200":
          description: List of posts
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/postResponse" }
    post:
      summary: Creates a new post
      tags: [posts]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/postCreateRequest" }
      responses:
        "201":
          description: post created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/postResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /api/v1/posts/{post_id}:
    parameters:
      - name: post_id
        in: path
        required: true
        schema: { type: integer, format: int64 }
    get:
      summary: Getting post by id
      tags: [posts]
      responses:
        "200":
          description: post found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/postResponse" }
        "404":
          description: post not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
    put:
      summary: Edit a post using id
      tags: [posts]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/postCreateRequest" }
      responses:
        "200":
          description: post updated successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/postResponse" }
        "400":
          description: Missing required fields
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: post not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Edit a post using id
      tags: [posts]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/postPatchRequest" }
      responses:
        "200":
          description: post patched successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/postResponse" }
        "400":
          description: Missing required fields
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: post not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete post using id
      tags: [posts]
      responses:
        "204":
          description: Deleted successfully

  # ==========================================
  # ENGAGEMENT SERVICE - COMMENTS
  # ==========================================

  /api/v1/posts/{post_id}/comments:
    get:
      tags: [comments]
      summary: Get root comment for a post
      description: |
        Fetches only top-level comments (parentId = null). 
        Use `replyCount` in response to decide whether to fetch replies.
      parameters:
        - name: post_id
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - name: cursor
          in: query
          description: ID/Time cursor for pagination
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CommentListResponse' }
  
  /api/v1/comments:
    post:
      tags: [comments]
      summary: Create a comment or reply
      description: Send `parentId` to reply, leave null for root comment.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentCreateRequest' }
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CommentResponse' }

  /api/v1/comments/{comment_id}:
    put: 
      tags: [comments]
      summary: Update comment content
      description: User can only edit the content, not the postId or parentId.
      parameters:
        - name: comment_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentUpdateRequest' }
      responses:
        '200':
          description: Updated successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CommentResponse' }
        '403':
          description: Not authorized to edit this comment
    
    delete:
      tags: [comments]
      summary: Soft delete a comment
      parameters:
        - name: comment_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Deleted

  /api/v1/comments/{comment_id}/replies:
    get:
      tags: [comments]
      summary: Get replies of a comment (Lazy loading)
      parameters:
        - name: comment_id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: cursor
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, default: 5 }
      responses:
        '200':
          description: List of replies
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CommentListResponse' }

  # ==========================================
  # ENGAGEMENT SERVICE - LIKES (POST INTEGRATION)
  # ==========================================

  /api/v1/posts/{post_id}/likes:
    get:
      tags: [likes]
      summary: Get list of users who liked the post
      parameters:
        - name: post_id
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: List of users who liked the post
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserListResponse' }
    
    post:
      tags: [likes]
      summary: Like a post
      parameters:
        - name: post_id
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '201':
          description: Liked successfully
        '409':
          description: Already liked

    delete:
      tags: [likes]
      summary: Unlike a post
      parameters:
        - name: post_id
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '204':
          description: Unliked successfully

  # ==========================================
  # ENGAGEMENT SERVICE - USER FOLLOWS (NEW)
  # ==========================================
  
  /api/v1/users/{target_user_id}/follow:
    post:
      tags: [follows]
      summary: Follow a user (author)
      description: |
        Action: Current logged-in user follows `target_user_id`.
        Use case: Use this when clicking "Follow" on a Profile or on a Post (get authorId from post data).
      parameters:
        - name: target_user_id
          in: path
          required: true
          schema: { type: integer }
          description: The ID of the user/author to follow
      responses:
        '204': 
          description: Followed successfully
        '400':
          description: Cannot follow yourself
        '409':
          description: Already following

    delete:
      tags: [follows]
      summary: Unfollow a user
      parameters:
        - name: target_user_id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '204': 
          description: Unfollowed successfully

  /api/v1/users/{user_id}/followers:
    get:
      tags: [follows]
      summary: Get list of followers
      description: List of people who are following `user_id`.
      parameters:
        - name: user_id
          in: path
          required: true
          schema: { type: integer }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: List of followers
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserListResponse' }

  /api/v1/users/{user_id}/following:
    get:
      tags: [follows]
      summary: Get list of following
      description: List of people that `user_id` is following.
      parameters:
        - name: user_id
          in: path
          required: true
          schema: { type: integer }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: List of people being followed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserListResponse' }

components:
  schemas:
    userResponse:
      type: object
      properties:
        id:
          type: integer
          description: user's id, autoincrement
          example: 1
        username:
          type: string
          description: username, must be unique
          example: 6myduck10293
        display_name:
          type: string
          description: user's display name
          example: 6myduck
        bio:
          type: string
          description: user's bio
          example: I'm the lord of all ducks
        avatar_url: 
          type: string
          description: Profile picture for the post.
          example: https://ipfs.io/ipfs/QmQA66xJFVcP5h8fs1PJt3fXeGwVPB55Q6o8PwEx1Jc2kz
        created_at:
          type: string
          format: date-time
          description: When the user created their account
          example: date-time
        updated_at:
          type: string
          format: date-time
          description: When the user info was last modified
          example: date-time
    roleResponse:
      type: object
      properties:
        id:
          type: integer
          description: role's id, autoincrement
          example: 1
        name:
          type: string
          description: role's name, must be unique
          example: 6myduck10293
        display_name:
          type: string
          description: user's display name
          example: 6myduck
        bio:
          type: string
          description: user's bio
          example: I'm the lord of all ducks
        avatar_url: 
          type: string
          description: Profile picture for the post.
          example: https://ipfs.io/ipfs/QmQA66xJFVcP5h8fs1PJt3fXeGwVPB55Q6o8PwEx1Jc2kz
        created_at:
          type: string
          description: When the user created their account
          example: date-time
        updated_at:
          type: string
          description: When the user info was last modified
          example: date-time

    # --- POST SCHEMAS ---
    postResponse:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: Dell precision 5540 }
        description: { type: string }
        price: { type: number }
        sku: { type: string }
        quantity: { type: integer }
        created_at: { type: integer }
        updated_at: { type: integer }
    postCreateRequest:
      type: object
      required: [name, price, quantity]
      properties:
        name: { type: string }
        description: { type: string }
        price: { type: number }
        sku: { type: string }
        quantity: { type: integer }
    postPatchRequest:
      type: object
      properties:
        name: { type: string }
        description: { type: string }
        price: { type: number }
        sku: { type: string }
        quantity: { type: integer }
    Error:
      type: object
      properties:
        error: { type: string }

    # --- ENGAGEMENT SCHEMAS ---
    UserSummary:
      type: object
      properties:
        id: { type: integer }
        username: { type: string }
        avatarUrl: { type: string, nullable: true }
    
    # [NEW] Dùng chung cho response trả về danh sách user (Likes, Followers, Following)
    UserListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/UserSummary' }
        meta:
          type: object
          properties:
            total: { type: integer }
            page: { type: integer }
            limit: { type: integer }
            totalPages: { type: integer }

    CommentCreateRequest:
      type: object
      required: [postId, content]
      properties:
        postId: { type: integer, format: int64 }
        parentId: { type: string, format: uuid, nullable: true }
        content: { type: string, minLength: 1, maxLength: 2000 }

    CommentUpdateRequest:
      type: object
      required: [content]
      properties:
        content: { type: string, minLength: 1, maxLength: 2000 }

    CommentResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        postId: { type: integer, format: int64 }
        parentId: { type: string, format: uuid, nullable: true }
        content: { type: string }
        user: { $ref: '#/components/schemas/UserSummary' }
        likeCount: { type: integer, default: 0 }
        replyCount: { type: integer, default: 0 }
        isLiked: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CommentListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/CommentResponse' }
        meta:
          type: object
          properties:
            nextCursor: { type: string, nullable: true }
            limit: { type: integer }